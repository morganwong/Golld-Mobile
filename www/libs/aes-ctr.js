/*global WorkerGlobalScope*/'use strict';if(typeof module!='undefined'&&module.exports)var Aes=require('./aes.js');Aes.Ctr={};Aes.Ctr.encrypt=function(plaintext,password,nBits){var blockSize=16;if(!(nBits==128||nBits==192||nBits==256))throw new Error('Key size is not 128 / 192 / 256');plaintext=String(plaintext).utf8Encode();password=String(password).utf8Encode();var nBytes=nBits/8;var pwBytes=new Array(nBytes);for(var i=0;i<nBytes;i++){pwBytes[i]=i<password.length?password.charCodeAt(i):0;}
    var key=Aes.cipher(pwBytes,Aes.keyExpansion(pwBytes));key=key.concat(key.slice(0,nBytes-16));var counterBlock=new Array(blockSize);var nonce=(new Date()).getTime();var nonceMs=nonce%1000;var nonceSec=Math.floor(nonce/1000);var nonceRnd=Math.floor(Math.random()*0xffff);for(var i=0;i<2;i++)counterBlock[i]=(nonceMs>>>i*8)&0xff;for(var i=0;i<2;i++)counterBlock[i+2]=(nonceRnd>>>i*8)&0xff;for(var i=0;i<4;i++)counterBlock[i+4]=(nonceSec>>>i*8)&0xff;var ctrTxt='';for(var i=0;i<8;i++)ctrTxt+=String.fromCharCode(counterBlock[i]);var keySchedule=Aes.keyExpansion(key);var blockCount=Math.ceil(plaintext.length/blockSize);var ciphertext='';for(var b=0;b<blockCount;b++){for(var c=0;c<4;c++)counterBlock[15-c]=(b>>>c*8)&0xff;for(var c=0;c<4;c++)counterBlock[15-c-4]=(b/0x100000000>>>c*8);var cipherCntr=Aes.cipher(counterBlock,keySchedule);var blockLength=b<blockCount-1?blockSize:(plaintext.length-1)%blockSize+1;var cipherChar=new Array(blockLength);for(var i=0;i<blockLength;i++){cipherChar[i]=cipherCntr[i]^plaintext.charCodeAt(b*blockSize+i);cipherChar[i]=String.fromCharCode(cipherChar[i]);}
        ciphertext+=cipherChar.join('');if(typeof WorkerGlobalScope!='undefined'&&self instanceof WorkerGlobalScope){if(b%1000==0)self.postMessage({progress:b/blockCount});}}
    ciphertext=(ctrTxt+ciphertext).base64Encode();return ciphertext;};Aes.Ctr.decrypt=function(ciphertext,password,nBits){var blockSize=16;if(!(nBits==128||nBits==192||nBits==256))throw new Error('Key size is not 128 / 192 / 256');ciphertext=String(ciphertext).base64Decode();password=String(password).utf8Encode();var nBytes=nBits/8;var pwBytes=new Array(nBytes);for(var i=0;i<nBytes;i++){pwBytes[i]=i<password.length?password.charCodeAt(i):0;}
    var key=Aes.cipher(pwBytes,Aes.keyExpansion(pwBytes));key=key.concat(key.slice(0,nBytes-16));var counterBlock=new Array(8);var ctrTxt=ciphertext.slice(0,8);for(var i=0;i<8;i++)counterBlock[i]=ctrTxt.charCodeAt(i);var keySchedule=Aes.keyExpansion(key);var nBlocks=Math.ceil((ciphertext.length-8)/ blockSize);var ct=new Array(nBlocks);for(var b=0;b<nBlocks;b++)ct[b]=ciphertext.slice(8+b*blockSize,8+b*blockSize+blockSize);ciphertext=ct;var plaintext='';for(var b=0;b<nBlocks;b++){for(var c=0;c<4;c++)counterBlock[15-c]=((b)>>>c*8)&0xff;for(var c=0;c<4;c++)counterBlock[15-c-4]=(((b+1)/0x100000000-1)>>>c*8)&0xff;var cipherCntr=Aes.cipher(counterBlock,keySchedule);var plaintxtByte=new Array(ciphertext[b].length);for(var i=0;i<ciphertext[b].length;i++){plaintxtByte[i]=cipherCntr[i]^ciphertext[b].charCodeAt(i);plaintxtByte[i]=String.fromCharCode(plaintxtByte[i]);}
        plaintext+=plaintxtByte.join('');if(typeof WorkerGlobalScope!='undefined'&&self instanceof WorkerGlobalScope){if(b%1000==0)self.postMessage({progress:b/nBlocks});}}
    plaintext=plaintext.utf8Decode();return plaintext;};if(typeof String.prototype.utf8Encode=='undefined'){String.prototype.utf8Encode=function(){return unescape(encodeURIComponent(this));};}
if(typeof String.prototype.utf8Decode=='undefined'){String.prototype.utf8Decode=function(){try{return decodeURIComponent(escape(this));}catch(e){return this;}};}
if(typeof String.prototype.base64Encode=='undefined'){String.prototype.base64Encode=function(){if(typeof btoa!='undefined')return btoa(this);if(typeof Buffer!='undefined')return new Buffer(this,'binary').toString('base64');throw new Error('No Base64 Encode');};}
if(typeof String.prototype.base64Decode=='undefined'){String.prototype.base64Decode=function(){if(typeof atob!='undefined')return atob(this);if(typeof Buffer!='undefined')return new Buffer(this,'base64').toString('binary');throw new Error('No Base64 Decode');};}
if(typeof module!='undefined'&&module.exports)module.exports=Aes.Ctr;